{
  "hash": "7b2ab59b4567f484c8379bebf3b2405d",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: Bug in nlme::lme with fixed sigma and REML estimation\ndate: '2016-11-07'\ncategories:\n- Rstats\n- programming\n- hierarchical models\n- nlme\ncode-tools: true\ndate-modified: '2024-06-07'\n---\n\n\nAbout one year ago, the `nlme` package introduced a feature that allowed the user to specify a fixed value for the residual variance in linear mixed effect models fitted with `lme()`. This feature is interesting to me because, when used with the `varFixed()` specification for the residual weights, it allows for estimation of a wide variety of meta-analysis models, including basic random effects models, bivariate models for estimating effects by trial arm, and other sorts of multivariate/multi-level random effects models. However, in kicking the tires on this feature, I noticed that the results that it produces are not quite consistent with the results produced by `metafor`, which is the main package I use for fitting meta-analytic models. \n\nIn this post, I document several examples of discrepant estimates between `lme()` and `rma.mv()`, using standard datasets included in the `metafor` package. The main take-aways are:\n\n1. The discrepancies arise only with `REML` estimation (not with `ML` estimation). \n2. The discrepancies are present whether or not the `varFixed` specification is used.\n3. The discrepancies are mostly small (with minimal impact on the standard errors of the fixed effect estimates), but are larger than I would expect from computational/convergence differences alone.\n\nAnother example, based on a different dataset, is documented in [this bug report](https://bugs.r-project.org/bugzilla3/show_bug.cgi?id=16975). Wolfgang Viechtbauer, author of the `metafor` package, identified this problem with `lme` a few months ago already (see his responses in [this thread](https://stat.ethz.ch/pipermail/r-sig-mixed-models/2016q2/024862.html) on the R mixed models mailing list) and noted that the issue was localized to REML estimation. My thanks to Wolfgang for providing feedback on this post.\n\n### Basic random effects model\n\nThis example fits a basic random effects model to the BCG vaccine data, available within `metafor`:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(metafor)\nlibrary(nlme)\n\nbcg_example <- function(method = \"REML\", constant_var = FALSE) {\n  \n  data(dat.bcg)\n  dat <- escalc(measure=\"OR\", ai=tpos, bi=tneg, ci=cpos, di=cneg, data=dat.bcg)\n  \n  v_bar <- mean(dat$vi)\n  if (constant_var) dat$vi <- v_bar\n  \n  # random-effects model using rma.uni()\n  LOR_uni_fit <- rma(yi, vi, data=dat, method = method)\n  LOR_uni <- with(LOR_uni_fit, \n                  data.frame(f = \"rma.uni\", \n                             logLik = logLik(LOR_uni_fit),\n                             est = as.numeric(b), \n                             se = se, \n                             tau = sqrt(tau2)))\n  \n  # random-effects model using rma.mv()\n  LOR_mv_fit <- rma.mv(yi, vi, random = ~ 1 | trial, data=dat, method = method)\n  LOR_mv <- with(LOR_mv_fit, \n                 data.frame(f = \"rma.mv\", \n                            logLik = logLik(LOR_mv_fit),\n                            est = as.numeric(b), \n                            se = se, \n                            tau = sqrt(sigma2)))\n  \n  # random-effects model using lme()\n  if (constant_var) {\n    LOR_lme_fit <- lme(yi ~ 1, data = dat, method = method, \n                       random = ~ 1 | trial,\n                       control = lmeControl(sigma = sqrt(v_bar)))\n    tau <- sqrt(as.numeric(coef(LOR_lme_fit$modelStruct$reStruct, unconstrained = FALSE)) * v_bar) \n  } else {\n    LOR_lme_fit <- lme(yi ~ 1, data = dat, method = method, \n                       random = ~ 1 | trial,\n                       weights = varFixed(~ vi),\n                       control = lmeControl(sigma = 1))\n    tau <- sqrt(as.numeric(coef(LOR_lme_fit$modelStruct$reStruct, unconstrained = FALSE)))\n  }\n  LOR_lme <- data.frame(f = \"lme\", \n                        logLik = logLik(LOR_lme_fit),\n                        est = as.numeric(fixef(LOR_lme_fit)), \n                        se = as.numeric(sqrt(vcov(LOR_lme_fit))), \n                        tau = tau)\n  \n  rbind(LOR_uni, LOR_mv, LOR_lme)\n  \n}\n\nbcg_example(\"REML\", constant_var = FALSE)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n        f    logLik        est        se       tau\n1 rma.uni -12.57566 -0.7451778 0.1860279 0.5811816\n2  rma.mv -12.57566 -0.7451778 0.1860280 0.5811818\n3     lme -13.34043 -0.7471979 0.1916902 0.6030524\n```\n\n\n:::\n\n```{.r .cell-code}\nbcg_example(\"REML\", constant_var = TRUE)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n        f    logLik        est        se       tau\n1 rma.uni -12.96495 -0.7716272 0.1977007 0.5911451\n2  rma.mv -12.96495 -0.7716272 0.1977007 0.5911452\n3     lme -15.62846 -0.7716272 0.1899448 0.5571060\n```\n\n\n:::\n\n```{.r .cell-code}\nbcg_example(\"ML\", constant_var = FALSE)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n        f    logLik        est        se       tau\n1 rma.uni -13.07276 -0.7419668 0.1779534 0.5499605\n2  rma.mv -13.07276 -0.7419669 0.1779534 0.5499608\n3     lme -13.07276 -0.7419668 0.1779534 0.5499605\n```\n\n\n:::\n\n```{.r .cell-code}\nbcg_example(\"ML\", constant_var = TRUE)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n        f     logLik        est        se       tau\n1 rma.uni -13.525084 -0.7716272 0.1899447 0.5571059\n2  rma.mv -13.525084 -0.7716272 0.1899447 0.5571059\n3     lme  -2.479133 -0.7716272 0.1899447 0.5571060\n```\n\n\n:::\n:::\n\n\n### Bi-variate random effects model\n\nThis example fits a bi-variate random effects model, also to the BCG vaccine data:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbcg_bivariate <- function(method = \"REML\", constant_var = FALSE) {\n  data(dat.bcg)\n  dat_long <- to.long(measure=\"OR\", ai=tpos, bi=tneg, ci=cpos, di=cneg, data=dat.bcg)\n  levels(dat_long$group) <- c(\"exp\", \"con\")\n  dat_long$group <- relevel(dat_long$group, ref=\"con\")\n  dat_long <- escalc(measure=\"PLO\", xi=out1, mi=out2, data=dat_long)\n\n  v_bar <- mean(dat_long$vi)\n  \n  if (constant_var) dat_long$vi <- v_bar\n  \n  # bivariate random-effects model using rma.mv()\n  \n  bv_rma_fit <- rma.mv(yi, vi, mods = ~ group, \n                       random = ~ group | study, \n                       struct = \"UN\", method = method,\n                       data=dat_long)\n  bv_rma <- with(bv_rma_fit, data.frame(f = \"rma.mv\",\n                                        logLik = logLik(bv_rma_fit),\n                                        tau1 = sqrt(tau2[1]),\n                                        tau2 = sqrt(tau2[2])))\n  \n  # bivariate random-effects model using lme()\n  if (constant_var) {\n    bv_lme_fit <- lme(yi ~ group, data = dat_long, method = method, \n                      random = ~ group | study,\n                      control = lmeControl(sigma = sqrt(v_bar)))\n    tau_sq <- colSums(coef(bv_lme_fit$modelStruct$reStruct, unconstrained = FALSE) * matrix(c(1,0,0, 1,2,1), 3, 2)) * v_bar\n    \n  } else {\n    bv_lme_fit <- lme(yi ~ group, data = dat_long, method = method, \n                      random = ~ group | study,\n                      weights = varFixed(~ vi),\n                      control = lmeControl(sigma = 1))\n    \n    tau_sq <- colSums(coef(bv_lme_fit$modelStruct$reStruct, unconstrained = FALSE) * matrix(c(1,0,0, 1,2,1), 3, 2))\n    \n  }\n  \n  bv_lme <- data.frame(f = \"lme\",\n                       logLik = logLik(bv_lme_fit),\n                       tau1 = sqrt(tau_sq[1]),\n                       tau2 = sqrt(tau_sq[2]))\n  \n  rbind(bv_rma, bv_lme)\n  \n}\n\nbcg_bivariate(\"REML\", constant_var = FALSE)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n       f    logLik     tau1     tau2\n1 rma.mv -31.50167 1.244429 1.617808\n2    lme -32.32612 1.254436 1.631619\n```\n\n\n:::\n\n```{.r .cell-code}\nbcg_bivariate(\"REML\", constant_var = TRUE)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n       f    logLik     tau1     tau2\n1 rma.mv -31.09623 1.191679 1.644897\n2    lme -37.06035 1.142260 1.578434\n```\n\n\n:::\n\n```{.r .cell-code}\nbcg_bivariate(\"ML\", constant_var = FALSE)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n       f    logLik     tau1     tau2\n1 rma.mv -33.08793 1.196399 1.551558\n2    lme -33.08793 1.196399 1.551558\n```\n\n\n:::\n\n```{.r .cell-code}\nbcg_bivariate(\"ML\", constant_var = TRUE)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n       f     logLik    tau1     tau2\n1 rma.mv -32.647023 1.14226 1.578434\n2    lme  -2.237355 1.14226 1.578435\n```\n\n\n:::\n:::\n\n\n### Three-level random-effects model\n\nThis example fits a three-level random-effects model to the data from Konstantopoulos (2011):\n\n\n::: {.cell}\n\n```{.r .cell-code}\nKonstantopoulos <- function(method = \"REML\", constant_var = FALSE) {\n  \n  dat <- get(data(dat.konstantopoulos2011))\n  v_bar <- mean(dat$vi)\n  if (constant_var) dat$vi <- v_bar\n  \n  # multilevel random-effects model using rma.mv()\n  ml_rma_fit <- rma.mv(yi, vi, random = ~ 1 | district/school, data=dat, method = method)\n  \n  ml_rma <- with(ml_rma_fit, \n                 data.frame(f = \"rma.mv\", \n                            logLik = logLik(ml_rma_fit),\n                            est = as.numeric(b), \n                            se = se, \n                            tau1 = sqrt(sigma2[1]), \n                            tau2 = sqrt(sigma2[2])))\n  \n  # multilevel random-effects model using lme()\n  if (constant_var) {\n    ml_lme_fit <- lme(yi ~ 1, data = dat, method = method, \n                      random = ~ 1 | district / school,\n                      control = lmeControl(sigma = sqrt(v_bar)))\n    tau <- sqrt(as.numeric(coef(ml_lme_fit$modelStruct$reStruct, unconstrained = FALSE)) * v_bar)\n    \n  } else {\n    ml_lme_fit <- lme(yi ~ 1, data = dat, method = method, \n                      random = ~ 1 | district / school,\n                      weights = varFixed(~ vi),\n                      control = lmeControl(sigma = 1))\n    tau <- sqrt(as.numeric(coef(ml_lme_fit$modelStruct$reStruct, unconstrained = FALSE)))\n    \n  }  \n  ml_lme <- data.frame(f = \"lme\",\n                       logLik = logLik(ml_lme_fit),\n                       est = as.numeric(fixef(ml_lme_fit)),\n                       se = as.numeric(sqrt(diag(vcov(ml_lme_fit)))),\n                       tau1 = tau[2],\n                       tau2 = tau[1])\n  \n  rbind(ml_rma, ml_lme)\n  \n}\n\nKonstantopoulos(\"REML\", constant_var = FALSE)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n       f     logLik       est         se      tau1      tau2\n1 rma.mv  -7.958724 0.1847132 0.08455592 0.2550724 0.1809324\n2    lme -10.716781 0.1841827 0.08641374 0.2605790 0.1884588\n```\n\n\n:::\n\n```{.r .cell-code}\nKonstantopoulos(\"REML\", constant_var = TRUE)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n       f     logLik       est         se      tau1      tau2\n1 rma.mv  -9.724839 0.1724309 0.08052701 0.2401816 0.1878155\n2    lme -16.119274 0.1724309 0.07980479 0.2380275 0.1848778\n```\n\n\n:::\n\n```{.r .cell-code}\nKonstantopoulos(\"ML\", constant_var = FALSE)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n       f    logLik       est         se      tau1      tau2\n1 rma.mv -8.394936 0.1844554 0.08048168 0.2402881 0.1812865\n2    lme -8.394936 0.1844554 0.08048168 0.2402881 0.1812865\n```\n\n\n:::\n\n```{.r .cell-code}\nKonstantopoulos(\"ML\", constant_var = TRUE)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n       f    logLik       est         se      tau1      tau2\n1 rma.mv -10.11095 0.1712365 0.07645094 0.2250687 0.1881229\n2    lme  90.21692 0.1712365 0.07645093 0.2250687 0.1881228\n```\n\n\n:::\n:::\n\n\n### Colophon\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsessioninfo::session_info()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n─ Session info ───────────────────────────────────────────────────────────────\n setting  value\n version  R version 4.3.3 (2024-02-29 ucrt)\n os       Windows 11 x64 (build 22621)\n system   x86_64, mingw32\n ui       RTerm\n language (EN)\n collate  English_United States.utf8\n ctype    English_United States.utf8\n tz       America/Chicago\n date     2024-06-07\n pandoc   3.1.11 @ C:/Program Files/RStudio/resources/app/bin/quarto/bin/tools/ (via rmarkdown)\n\n─ Packages ───────────────────────────────────────────────────────────────────\n ! package     * version    date (UTC) lib source\n P cli           3.6.2      2023-12-11 [?] CRAN (R 4.3.3)\n P digest        0.6.35     2024-03-11 [?] CRAN (R 4.3.3)\n P evaluate      0.23       2023-11-01 [?] CRAN (R 4.3.3)\n P fastmap       1.1.1      2023-02-24 [?] CRAN (R 4.3.3)\n P htmltools     0.5.7      2023-11-03 [?] CRAN (R 4.3.3)\n P htmlwidgets   1.6.4      2023-12-06 [?] RSPM\n P jsonlite      1.8.8      2023-12-04 [?] CRAN (R 4.3.3)\n P knitr         1.45       2023-10-30 [?] CRAN (R 4.3.3)\n P lattice       0.22-5     2023-10-24 [?] CRAN (R 4.3.3)\n P mathjaxr      1.6-0      2022-02-28 [?] RSPM\n P Matrix      * 1.6-5      2024-01-11 [?] CRAN (R 4.3.3)\n P metadat     * 1.2-0      2022-04-06 [?] RSPM\n P metafor     * 4.6-0      2024-03-28 [?] RSPM\n   nlme        * 3.1-165    2024-06-06 [1] RSPM (R 4.3.0)\n P numDeriv    * 2016.8-1.1 2019-06-06 [?] RSPM\n   renv          1.0.5      2024-02-29 [1] CRAN (R 4.3.3)\n P rlang         1.1.3      2024-01-10 [?] CRAN (R 4.3.3)\n P rmarkdown     2.26       2024-03-05 [?] CRAN (R 4.3.3)\n P rstudioapi    0.16.0     2024-03-24 [?] RSPM\n P sessioninfo   1.2.2      2021-12-06 [?] RSPM\n P xfun          0.42       2024-02-08 [?] CRAN (R 4.3.3)\n P yaml          2.3.8      2023-12-11 [?] CRAN (R 4.3.2)\n\n [1] C:/Users/jamespustejovsky/Documents/jepusto-quarto/renv/library/R-4.3/x86_64-w64-mingw32\n [2] C:/Users/jamespustejovsky/AppData/Local/R/cache/R/renv/sandbox/R-4.3/x86_64-w64-mingw32/7cdaab8d\n\n P ── Loaded and on-disk path mismatch.\n\n──────────────────────────────────────────────────────────────────────────────\n```\n\n\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}
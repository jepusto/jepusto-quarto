---
title: Step-function selection models for meta-analysis
date: '2024-07-08'
categories:
- effect size
- distribution theory
- selective reporting
draft: true
execute:
  echo: false
bibliography: "../selection-references.bib"
csl: "../apa.csl"
link-citations: true
code-tools: true
toc: true
css: styles.css
crossref: 
  eq-prefix: ""
---

In [a recent post](/posts/distribution-of-significant-effects/) I looked at the distribution of statistically significant effect sizes in studies that report multiple outcomes, when those studies are subject to a certain form of selective reporting. 
I considered a model where each effect size within the study is more likely to be reported when it is _affirmative_---or statistically significant and in the hypothesized direction---than when it is _non-affirmative_. 
Because studies with multiple effect sizes are a very common occurrence in social science meta-analysis, it's interesting to think about how this form of selection leads to distortions of the results that are actually reported and available for meta-analysis. 
In this post, I want to look a different scenario that is simpler in one respect but more complicated in another. 
Simpler, in that I'm going to ignore dependence issues and just think about the distribution of one effect size at a time. 
More complicated, in that I'm going to look at a more general model for how selective reporting occurs, which I'll call the __*step-function selection model*__.

# The step-function selection model 

The step-function selection model was introduced by @hedges1992modeling and has been further expanded, tweaked, and studied in a bunch of subsequent work. 
The model has two components: a set of assumptions about how effect size estimates are generated prior to selection (the __*evidence-generation process*__), and a set of assumptions about how selective reporting happens as a function of the effect size estimates (the __*selective reporting process*__). 
In the original formulation, the evidence-generation process is a random effects model. Letting $T_i^*$ denote an effect size estimate prior to selective reporting and $\sigma_i^*$ denote its (known) standard error, we assume that
$$
T_i^* | \sigma_i^* \sim N\left(\mu, \tau^2 + \left(\sigma_i^*\right)^2\right),
$$ {#eq-evidence-generation}
just as in the conventional random effects model. Here $\mu$ is the overall average effect size and $\tau$ is the standard deviation of the effect size parameter distribution.

For the second component, we assume that the selective-reporting process is fully determined by the statistical significance and sign of the effect size estimates. We can therefore formalize the selective reporting process in terms of the one-sided p-values of the effect size estimates. Assuming that the degrees of freedom are large enough to not worry about, the one-sided p-value for effect size $i$ is a transformation of the effect size and its standard error:
$$
p_i^* = 1 - \Phi\left(T_i^* / \sigma_i^*\right)
$$ {#eq-p-onesided}
In the step-function model, we assume that the probability that an effect size estimate is reported (and thus available for meta-analysis) depends on where this one-sided p-value lies relative to a pre-specified set of significance thresholds, $\alpha_1,...,\alpha_H$. These thresholds define a set of intervals, each of which can have a different probability of selection.
Let $O_i^*$ be a binary indicator equal to 1 if $T_i^*$ is reported and otherwise equal to zero. 
The selective reporting process is then
$$
\Pr\left(O_i^* = 1| T_i^*, \sigma_i^*\right) = \begin{cases}
1 & \text{if} \quad p_i^* < \alpha_1 \\ 
\lambda_1 & \text{if} \quad \alpha_h \leq p_i^* < \alpha_{h+1}, \quad h = 1,...,H-1 \\ 
\lambda_H & \text{if} \quad \alpha_H \leq p_i^* \\ 
\end{cases}.
$$ {#eq-selection-process}
Note that the selection probability for the lowest interval $[0, \alpha_1)$ is fixed to 1 because we can't estimate the absolute probability that an effect size estimate is reported. 
The remaining parameters of the selection process therefore each represent a ratio of the probability of reporting an effect size estimate falling in a given interval to the probability of reporting an effect size estimate falling in the lowest interval.

In practice, the analyst will need to specify the thresholds of the significance intervals in order to estimate the model. One common choice is to use only a single threshold at $\alpha_1 = .025$, which corresponds to a two-sided level of .05---Fisher's vaunted criteria for when a result should be considered significant. This is the so-called "three-parameter" selection model, where the parameters of interest are the average effect size $\mu$, the heterogeneity SD $\tau$, and the relative selection probability $\lambda_1$. Other possible choices for thresholds might be:

* A single threshold at $\alpha_1 = .50$, so that negatively-signed effect size estimates have a different selection probability than positively-signed estimates;
* A two-threshold model with $\alpha_1 = .025$ and $\alpha_2 = .50$ (I like to call this a four-parameter selection model); or
* A model with thresholds for significant, positive results at $\alpha_1 = .025$, for the sign of the estimate at $\alpha_2 = .50$, and for statistically significant results in the opposite of the expected direction at $\alpha_3 = .975$. 

Many other choices are possible, of course.

# Distribution of observed effect sizes

Equations (@eq-evidence-generation) and (@eq-selection-process) are sufficient to describe the distribution of effect sizes actually observed after selection. If we let $T_i$ and $\sigma_i$ denote effect size estimates that are actually observed, then the distribution of $\left(T_i | \sigma_i\right)$ is the same as that of $\left(T_i^* | \sigma_i^*, O_i^* = 1\right)$. By Bayes Theorem, 
$$
\Pr(T = t | \sigma_i) = \frac{\Pr\left(O_i^* = 1| T_i^* = t, \sigma_i^* = \sigma_i\right) \times \Pr(T_i^*  = t| \sigma_i^* = \sigma_i)}{\Pr\left(O_i^* = 1| \sigma_i^* = \sigma_i\right)}
$$ {#eq-observed-effect-distribution}
For the specific distributional assumptions of the step-function selection model, we can find an expression for the exact form of (@eq-observed-effect-distribution). 
In doing so, it will be useful to define a further random variable---call it $S_i$---that is equal to the p-value interval into which effect size $T_i$ falls. For a given effect size with standard error $\sigma_i^*$, these intervals are equivalent to intervals on the scale of the outcome, with thresholds $\gamma_{hi} = \sigma_i^* \Phi^{-1}(1 - \alpha_h)$. Now, let's define $S_i^*$ as
$$
S_i^* = \begin{cases}
0 & \text{if} \quad \gamma_{1i} < T_i^* \\ 
h & \text{if} \quad \gamma_{h+1,i} < T_i^* \leq \gamma_{hi}, \quad h = 1,...,H-1 \\ 
H & \text{if} \quad T_i^* \leq \gamma_{Hi} \\ 
\end{cases}
$$
and $S_i$ as the corresponding interval for the observed effect size $T_i$.
Note that (@eq-selection-process) is equivalent to writing the relative selection probabilities as a function of $S_i$:
$$
w\left(T_i^*, \sigma_i^*\right) = \lambda_{S_i^*}
$$ {#eq-selection-weights}
Also note that, prior to selection, the effect size estimate $T_i^*$ has marginal variance $\eta_i^2 = \tau^2 + \left(\sigma_i^*\right)^2$, so we can write $\Pr(T_i^*  = t| \sigma_i^*) =  \frac{1}{\eta_i}\phi\left(\frac{t - \mu}{\eta_i}\right)$, where $\phi()$ is the standard normal density.  We can then write the distribution of the observed effect size estimates as
$$
\Pr(T_i = t | \sigma_i) = \frac{w\left(t, \sigma_i\right) \times \frac{1}{\eta_i}\phi\left(\frac{t - \mu}{\eta_i}\right)}{A_i},
$$ {#eq-observed-effect-density}
where
$$
\begin{aligned}
A_i &= \int w\left(t, \sigma_i^*\right) \times \frac{1}{\eta_i}\phi\left(\frac{t - \mu}{\eta_i}\right) dt \\
&= \sum_{h=0}^H \lambda_h B_{hi},
\end{aligned}
$$
with 
$$
B_{hi} = \Phi\left(\frac{\gamma_{hi} - \mu}{\eta_i}\right) - \Phi\left(\frac{\gamma_{h+1,i} - \mu}{\eta_i}\right)
$$
and where we take $\lambda_0 = 1$, $\alpha_0 = 0$, and $\alpha_{H+1} = 1$ [@hedges2005selection]. Note that $A_i  = \Pr(O^* = 1 | \sigma_i^*)$, the probability that an effect size estimate with precision $\sigma_i^*$ will be observed.

The observed effect size estimates follow what we might call a "piece-wise normal" distribution. 
For a given $\sigma_i$ and given the interval $S_i$ into which the effect size falls, the effect size follows a truncated normal distribution. Formally, 
$$
\left(T_i | S_i = h, \sigma_i \right) \sim TN(\mu,\eta_i^2, \gamma_{h+1,i},\gamma_{h i}).
$$
Furthermore, the distribution of $S_i$ is given by
$$
\Pr(S_i = h | \sigma_i) = \frac{\lambda_h B_{hi}}{\sum_{g=0}^H \lambda_g B_{gi}},
$$
which will be useful for deriving moments of the distribution of $T_i$.

Here is an interactive graph showing the distribution of the effects prior to selection (in grey) and the distribution of observed effect sizes (in blue), using selection thresholds of $\alpha_1 = .025$ and $\alpha_2 = .50$. Initially, the selection parameters are set to $\lambda_1 = 0.6$ and $\lambda_2 = 0.3$, but you can change these however you like.

```{ojs}
math = require("mathjs")
norm = import('https://unpkg.com/norm-dist@3.1.0/index.js?module')

eta = math.sqrt(tau**2 + sigma**2)
H = 2
alpha = [.025, .500]
lambda = [1, lambda1, lambda2]

function findlambda(p, alpha, lambda) {
  var m = 0;
  while (p >= alpha[m]) {
    m += 1;
  }
  return lambda[m];
}

gamma_h = Array(H+2).fill(null).map((x,i) => {
  if (i==0) {
    return Infinity;
  } else if (i==H+1) {
    return -Infinity;
  } else {
    return sigma * norm.icdf(1 - alpha[i-1]);
  }
})

c_h = Array(H+2).fill(null).map((x,i) => {
  return (gamma_h[i] - mu) / eta;
})

B_h = Array(H+1).fill(null).map((x,i) => {
  return norm.cdf(c_h[i]) - norm.cdf(c_h[i+1])
})

Ai = {
  let A = 0;
  for (let i = 0; i <= H; i++) {
  	A += lambda[i] * B_h[i];
  }
  return A;
}

Ai_toprint = Ai.toFixed(3)
```

```{ojs}

function weighted_mean(x) {
  let top = 0;
  for (let i = 0; i <= H; i++) {
  	top += lambda[i] * B_h[i] * x[i];
  }
  return top / Ai;
}

psi_h = Array(H+1).fill(null).map((x,i) => {
  return (norm.pdf(c_h[i+1]) - norm.pdf(c_h[i])) / B_h[i]
})

psi_bar = weighted_mean(psi_h)
ET = mu + eta * psi_bar

ET_toprint = ET.toFixed(3)

dc_h = c_h.map((c_val) => {
  if (math.abs(c_val) == Infinity) {
    return 0;
  } else {
    return c_val * norm.pdf(c_val);
  }
})

V_h = Array(H+1).fill(null).map((x,i) => {
  let kappa = (dc_h[i] - dc_h[i+1]) / B_h[i]    
  return (1 - kappa - psi_bar**2);
})

SDT = eta * math.sqrt(weighted_mean(V_h))
eta_toprint = eta.toFixed(3)
SDT_toprint = SDT.toFixed(3)
```

```{ojs}
pts = 201

dat = Array(pts).fill().map((element, index) => {
  let t = mu - 3 * eta + index * eta * 6 / (pts - 1);
  let p = 1 - norm.cdf(t / sigma);
  let dt = norm.pdf((t - mu) / eta) / eta;
  let lambda_val = findlambda(p, alpha, lambda);
  return ({
    t: t,
    d_unselected: dt,
    d_selected: lambda_val * dt
  })
})

```

::::: {.grid .column-page-inset}

:::: {.g-col-7}

```{ojs}
Plot.plot({
  height: 300,
  y: {
    grid: false,
    label: "Density"
  },
  x: {
    label: "Effect size estimate (Ti)"
  },   
  marks: [
    Plot.ruleY([0]),
    Plot.ruleX([0]),
    Plot.areaY(dat, {x: "t", y: "d_unselected", fillOpacity: 0.3}),
    Plot.areaY(dat, {x: "t", y: "d_selected", fill: "blue", fillOpacity: 0.5}),
    Plot.lineY(dat, {x: "t", y: "d_selected", stroke: "blue"})
  ]
})
```

:::{.moments}

```{ojs}
tex`
\begin{aligned}
\mu &= ${mu} & \qquad \eta &= ${eta_toprint} \\
\mathbb{E}\left(T_i\right) &= ${ET_toprint}
& \qquad \sqrt{\mathbb{V}\left(T_i\right)} &= ${SDT_toprint} \\ 
\Pr(O_i^* = 1) &= ${Ai_toprint}
\end{aligned}
`
```
:::

::::

:::: {.g-col-5}

```{ojs}
//| panel: input

viewof mu = Inputs.range(
  [-2, 2], 
  {value: 0.15, step: 0.01, label: "Average effect size (mu):"}
)

viewof tau = Inputs.range(
  [0, 2], 
  {value: 0.10, step: 0.01, label: "Heterogeneity SD (tau):"}
)

viewof sigma = Inputs.range(
  [0, 1], 
  {value: 0.20, step: 0.01, label: "Standard error (sigma):"}
)

viewof lambda1 = Inputs.range(
  [0, 2],
  {value: 0.60, step: 0.01, label: "Selection probability over .025 < p <= .500 (lambda1)"}
)

viewof lambda2 = Inputs.range(
  [0, 2],
  {value: 0.30, step: 0.01, label: "Selection probability over .500 < p (lambda2)"}
)

```

::::


:::::

# Moments of $T_i | \sigma_i$

Using the auxiliary random variable $S_i$ makes it pretty straight-forward to find the moments of $T_i | \sigma_i$. Let me denote
$$
\psi_{hi} = \frac{\phi\left(c_{h+1,i}\right) - \phi\left(c_{hi}\right)}{B_{hi}},
$$
where $c_{hi} = \left(\gamma_{hi} - \mu\right) / \eta_i$ for $h=0,...,H$.
Then from the properties of truncated normal distributions, 
$$
\mathbb{E}(T_i | S_i = h, \sigma_i) = \mu + \eta_i \times \psi_{hi},
$$
It follows immediately that
$$
\begin{aligned}
\mathbb{E}(T_i | \sigma_i) &= \sum_{h=0}^H \Pr(S_i = h | \sigma_i) \times \mathbb{E}(T_i | S_i = h, \sigma_i) \\
&= \mu + \eta_i \frac{\sum_{h=0}^H \lambda_h B_{hi} \psi_{hi}}{\sum_{h=0}^H \lambda_h B_{hi}}.
\end{aligned}
$$ {#eq-Ti-expectation}
The second term of @eq-Ti-expectation is the bias of $T_i$ relative to the overall mean effect $\mu$. Generally, it will depend on all the parameters of the evidence-generating process, including $\sigma_i$, $\mu$, and $\tau$ (through the $c_{hi}$ and $B_{hi}$ terms) and on the selection weights $\lambda_1,...,\lambda_H$.

Just for giggles, let me chug through and get the variance of $T_i$ as well. Letting 
$$
\bar\psi_i = \frac{\sum_{h=0}^H \lambda_h B_{hi} \psi_{hi}}{\sum_{h=0}^H \lambda_h B_{hi}}
$$
and
$$
\kappa_{hi} = \frac{c_{hi} \phi\left(c_{hi}\right) - c_{h+1,i} \phi\left(c_{h+1,i}\right)}{B_{hi}},
$$
we can write the variance of the truncated normal conditional distribution
$$
\mathbb{V}(T_i | S_i = h, \sigma_i) = \eta_i^2 \left(1 - \kappa_{hi} - \psi_{hi}^2\right).
$$
Using variance decomposition, we then have
$$
\begin{aligned}
\mathbb{V}(T_i | \sigma_i) &= \mathbb{E}\left[\mathbb{V}(T_i | S_i, \sigma_i)\right] + \mathbb{V}\left[\mathbb{E}(T_i | S_i, \sigma_i)\right] \\
&= \mathbb{E}\left[\mathbb{V}(T_i | S_i, \sigma_i) + \left[\mathbb{E}(T_i | S_i, \sigma_i) - \mathbb{E}(T_i | \sigma_i)\right]^2\right] \\
&= \frac{1}{\sum_{h=0}^H \lambda_h B_{hi}} \sum_{h=0}^H \lambda_h B_{hi} \left( \eta_i^2 \left(1 - \kappa_{hi} - \psi_{hi}^2\right) + \eta_i^2  \left[\psi_{hi} - \bar\psi_i \right]^2\right) \\
&= \eta_i^2 \frac{\sum_{h=0}^H \lambda_h B_{hi} \left(1 - \kappa_{hi} - \bar\psi_i^2\right)}{\sum_{h=0}^H \lambda_h B_{hi}}.
\end{aligned}
$$
Just as with the expectation, the variance is a complicated function of all the model parameters. 
Although these expressions are pretty complex, it seems like they could be useful for studying the properties of different estimators that have been proposed for dealing with selective reporting, such as the "unrestricted weighted least squares" method, which is just the idea of using fixed effects weights even though the effects are heterogeneous [@henmi2010confidence; @stanley2014metaregression]; the PET and PEESE estimators [@stanley2008metaregression]; the endogenous kink meta-regression [@bom2019kinked]; and perhaps other estimators in the literature.

```{r}
pwnormal <- function(mu, tau, sigma, alpha, lambda) {
  eta <- sqrt(tau^2 + sigma^2)
  H <- length(alpha)
  alpha_f <- c(0, alpha, 1)
  lambda_f <- c(1, lambda)
  c_h <- (sigma * qnorm(1 - alpha_f) - mu) / eta
  B_h <- pnorm(c_h[-(H+2)]) - pnorm(c_h[-1])
  A <- sum(B_h * lambda_f)
  pr_h <- B_h * lambda_f / A
  function(x) {
    x_interval <- cut(x, breaks = sigma * qnorm(1 - alpha_f), include.lowest = TRUE)
    wt <- rev(lambda_f)[x_interval]
    gen_prob <- dnorm((x - mu) / eta) / eta
    wt * gen_prob / A
  }
}
```

# Funnel density

```{ojs}
funnel_dat = Array(t_pts * SE_pts).fill(null).map((x,row) => {
  let i = row % SE_pts;
  let j = (row - i) / SE_pts;
  let sigma = i * 0.5 / SE_pts;
  let eta_max = math.sqrt(tau**2 + 0.5**2);
  let t = mu - 3 * eta_max + j * eta_max * 6 / (t_pts - 1);
  let eta = math.sqrt(tau**2 + sigma**2);
  let p = 1 - norm.cdf(t / sigma);
  let dt = norm.pdf((t - mu) / eta) / eta;
  let lambda_val = findlambda(p, alpha, lambda);
  return ({i: i, j: j, t: t, sigma: sigma, d_selected: lambda_val * dt});
})
```


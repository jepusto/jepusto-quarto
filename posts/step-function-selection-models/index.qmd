---
title: Step-function selection models for meta-analysis
date: '2024-06-18'
categories:
- effect size
- distribution theory
- selective reporting
draft: true
execute:
  echo: false
bibliography: "../selection-references.bib"
csl: "../apa.csl"
link-citations: true
code-tools: true
toc: true
crossref: 
  eq-prefix: ""
---

In [a recent post](/posts/distribution-of-significant-effects/) I looked at the distribution of statistically significant effect sizes in studies that report multiple outcomes, when those studies are subject to a certain form of selective reporting. 
Specifically, I considered a scenario where each effect size within the study is more likely to be reported when it is __affirmative__---or statistically significant and in the hypothesized direction---than when it is __non-affirmative__. 
Because studies with multiple effect sizes are a very common occurrence in social science meta-analysis, it's interesting to think about how this form of selection leads to distortions of the results that are actually reported and available for meta-analysis. 
In this post, I want to look a different scenario that is simpler in one respect but more complicated in another. 
Simpler, in that I'm going to ignore dependence issues and just think about the distribution of one effect size at a time. 
More complicated, in that I'm going to look at a more general model for how selective reporting occurs, which I'll call the __*step-function selection model*__.

# The step-function selection model 

The step-function selection model was introduced by @hedges1992modeling and has been further expanded, tweaked, and studied in a bunch of subsequent work. 
The model has two components: a set of assumptions about how effect size estimates are generated prior to selection (the __*evidence-generation process*__), and a set of assumptions about how selective reporting happens as a function of the effect size estimates (the __*selective reporting process*__). 
In the original formulation, the evidence-generation process is a random effects model. Letting $T_i^*$ denote an effect size estimate prior to selective reporting and $\sigma_i^*$ denote its standard error, we assume that
$$
T_i^* | \sigma_i^* \sim N\left(\mu, \tau^2 + \left(\sigma_i^*\right)^2\right),
$$ {#eq-evidence-generation}
just as in the conventional random effects model. Here $\mu$ is the overall average effect size and $\tau$ is the standard deviation of the effect size distribution.

For the second component, we assume that the selective-reporting process is fully determined by the statistical significance and sign of the effect size estimates. We can therefore formalize the selective reporting process in terms of the one-sided p-values of the effect size estimates. Assuming that the degrees of freedom are large enough to not worry about, the one-sided p-value for effect size $i$ is a transformation of the effect size and its standard error:
$$
p_i^* = 1 - \Phi\left(T_i^* / \sigma_i^*\right)
$$ {#eq-p-onesided}
In the step-function model, we assume that the probability that an effect size estimate is reported (and thus available for meta-analysis) depends on where this one-sided p-value lies relative to a pre-specified set of significance thresholds, $\alpha_1,...,\alpha_H$. These thresholds define a set of intervals, each of which can have a different probability of selection.
Let $O_i^*$ be a binary indicator equal to 1 if $T_i^*$ is reported and otherwise equal to zero. 
The selective reporting process is then
$$
\Pr\left(O_i^* = 1| T_i^*, \sigma_i^*\right) = \begin{cases}
1 & \text{if} \quad p_i^* < \alpha_1 \\ 
\lambda_1 & \text{if} \quad \alpha_h \leq p_i^* < \alpha_{h+1}, \quad h = 1,...,H-1 \\ 
\lambda_H & \text{if} \quad \alpha_H \leq p_i^* \\ 
\end{cases}.
$$ {#eq-selection-process}
Note that the selection probability for the lowest interval $[0, \alpha_1)$ is fixed to 1 because we can't estimate the absolute probability that an effect size estimate is reported. 
The remaining parameters of the selection process therefore each represent a ratio of the probability of reporting an effect size estimate falling in a given interval to the probability of reporting an effect size estimate falling in the lowest interval.

In practice, the analyst will need to specify the thresholds of the significance intervals in order to estimate the model. One common choice is to use only a single threshold at $\alpha_1 = .025$, which corresponds to a two-sided level of .05---Fisher's vaunted criteria for when a result should be considered significant. This is the so-called "three-parameter" selection model, where the parameters of interest are the average effect size $\mu$, the heterogeneity SD $\tau$, and the relative selection probability $\lambda_1$. Other possible choices for thresholds might be:

* A single threshold at $\alpha_1 = .50$, so that negatively-signed effect size estimates have a different selection probability than positively-signed estimates;
* A two-threshold model with $\alpha_1 = .025$ and $\alpha_2 = .50$ (I like to call this a four-parameter selection model); or
* A model with thresholds for significant, positive results at $\alpha_1 = .025$, for the sign of the estimate at $\alpha_2 = .50$, and for statistically significant results in the opposite of the expected direction at $\alpha_3 = .975$. 

Many other choices are possible, of course.

# Distribution of observed effect sizes

Equations (@eq-evidence-generation) and (@eq-selection-process) are sufficient to describe the distribution of effect sizes actually observed after selection. If we let $T_i$ and $\sigma_i$ denote effect size estimates that are actually observed, then the distribution of $\left(T_i | \sigma_i\right)$ is the same as that of $\left(T_i^* | \sigma_i^*, O_i^* = 1\right)$. By Bayes Theorem, 
$$
\Pr(T = t | \sigma_i) = \frac{\Pr\left(O_i^* = 1| T_i^* = t, \sigma_i^* = \sigma_i\right) \times \Pr(T_i^*  = t| \sigma_i^* = \sigma_i)}{\Pr\left(O_i^* = 1| \sigma_i^* = \sigma_i\right)}
$$ {#eq-observed-effect-distribution}
For the specific distributional assumptions of the step-function selection model, we can find an expression for the exact form of (@eq-observed-effect-distribution). 
Note that (@eq-selection-process) is equivalent to writing the relative selection probabilities as a function of $T_i^*$ and $\sigma_i^*$:
$$
w\left(T_i^*, \sigma_i^*\right) = \begin{cases}
1 & \text{if} \quad -\sigma_i^*  \Phi^{-1}\left(\alpha_1\right) < T_i^* \\ 
\lambda_1 & \text{if} \quad -\sigma_i^*  \Phi^{-1}\left(\alpha_{h+1}\right) < T_i^* \leq -\sigma_i^*  \Phi^{-1}\left(\alpha_h\right), \quad h = 1,...,H-1 \\ 
\lambda_H & \text{if} \quad T_i^* \leq -\sigma_i^*  \Phi^{-1}\left(\alpha_H \right) \\ 
\end{cases}.
$$ {#eq-selection-weights}
Also note that, prior to selection, the effect size estimate $T_i^*$ have marginal variance $\eta_i^2 = \tau^2 + \left(\sigma_i^*\right)^2$, so we can write $\Pr(T_i^*  = t| \sigma_i^*) =  \frac{1}{\eta_i}\phi\left(\frac{t - \mu}{\eta_i}\right)$, where $\phi()$ is the standard normal density.  We can then write the distribution of the observed effect size estimates as
$$
\Pr(T = t | \sigma_i) = \frac{w\left(t, \sigma_i\right) \times \frac{1}{\eta_i}\phi\left(\frac{t - \mu}{\eta_i}\right)}{A_i},
$$ {#eq-observed-effect-density}
where
$$
\begin{aligned}
A_i &= \int w\left(t, \sigma_i^*\right) \times \frac{1}{\eta_i}\phi\left(\frac{t - \mu}{\eta_i}\right) dt \\
&= \sum_{h=0}^H \lambda_h \left[\Phi(c_{hi}) - \Phi(c_{h+1,i})\right],
\end{aligned}
$$
with $c_{hi} = \left(-\sigma_i^* \Phi^{-1}(\alpha_h) - \mu\right) / \eta_i$ and we take $\lambda_0 = 1$, $\alpha_0 = 0$, and $\alpha_{H+1} = 1$ [@hedges2005selection].

The observed effect size estimates follow what we might call a "piece-wise normal" distribution. 
For a given $\sigma_i$, the p-value thresholds correspond to fixed intervals of the range of $T_i$, and $T_i$ follows a truncated normal distribution within each interval. 
Here are some pictures of these distributions for a few different values of $\mu$, $\tau$, and $\sigma_i$, using selection thresholds of $\alpha_1 = .025$ and $\alpha_2 = .50$ with $\lambda_1 = 0.6$ and $\lambda_2 = 0.3$:
```{r}
pwnormal <- function(mu, tau, sigma, alpha, lambda) {
  eta <- sqrt(tau^2 + sigma^2)
  H <- length(alpha)
  alpha_f <- c(0, alpha, 1)
  lambda_f <- c(1, lambda)
  c_h <- (sigma * qnorm(1 - alpha_f) - mu) / eta
  B_h <- pnorm(c_h[-(H+2)]) - pnorm(c_h[-1])
  A <- sum(B_h * lambda_f)
  pr_h <- B_h * lambda_f / A
  function(x) {
    x_interval <- cut(x, breaks = sigma * qnorm(1 - alpha_f), include.lowest = TRUE)
    wt <- rev(lambda_f)[x_interval]
    gen_prob <- dnorm((x - mu) / eta) / eta
    wt * gen_prob / A
  }
}
```

```{ojs}
math = require("mathjs")
norm = import('https://unpkg.com/norm-dist@3.1.0/index.js?module')

lambda = Array(H+1).fill(1)

eta = math.sqrt(tau**2 + sigma**2)

```

:::: {.grid .column-page-inset}

::: {.g-col-7}

:::

::: {.g-col-5}

```{ojs}
//| panel: input

viewof H = Inputs.range(
  [1, 10], 
  {value: 1, step: 1, label: "Number of thresholds (H):"}
)

viewof mu = Inputs.range(
  [-2, 2], 
  {value: 0, step: 0.01, label: "Average effect size (mu):"}
)

viewof tau = Inputs.range(
  [0, 2], 
  {value: 0.10, step: 0.01, label: "Heterogeneity SD (tau):"}
)

viewof sigma = Inputs.range(
  [0, 1], 
  {value: 0.10, step: 0.01, label: "Standard error (sigma):"}
)

```
:::

::::
